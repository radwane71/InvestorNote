<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø§Ø³Ø¨Ø© ÙƒØ±Ø© Ø§Ù„Ø«Ù„Ø¬ - Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #e8f0f5 0%, #d0e0e8 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; }

        .calculator-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-panel, .results-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #5a9d7a;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #34495e; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #5a9d7a;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .checkbox-group {
            display: flex; align-items: center;
            padding: 15px; background: #f8f9fa; border-radius: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto; margin-left: 10px; transform: scale(1.2);
        }

        .radio-group { display: flex; gap: 20px; margin-top: 8px; }
        .radio-option {
            display: flex; align-items: center; cursor: pointer;
            padding: 8px 12px; border-radius: 6px; transition: background-color 0.3s ease;
        }
        .radio-option:hover { background-color: #f8f9fa; }
        .radio-option input[type="radio"] { margin-left: 8px; margin-right: 0; }

        .calculate-btn {
            width: 100%; padding: 15px;
            background: linear-gradient(135deg, #5a9d7a, #6aad8a);
            color: white; border: none; border-radius: 10px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s; margin-top: 20px;
        }
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(90, 157, 122, 0.3);
        }

        .summary-cards {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 20px; margin-bottom: 20px;
        }
        .summary-card {
            background: linear-gradient(135deg, #5a7fb5 0%, #6a8fc5 100%);
            color: white; padding: 20px; border-radius: 15px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-card.deposits { background: linear-gradient(135deg, #5a7fb5, #4a6fa5); }
        .summary-card.earnings { background: linear-gradient(135deg, #5a9d7a, #4a8d6a); }
        .summary-card.final   { background: linear-gradient(135deg, #d67a6a, #c66a5a); }
        .summary-card h3 { font-size: 0.9rem; margin-bottom: 10px; opacity: 0.9; }
        .summary-card .amount { font-size: 1.6rem; font-weight: bold; }

        /* Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø¹Ø¯Ù… Ø§Ù„ØªÙˆØ§ÙÙ‚ */
        .warning-box {
            background: #fff3cd; border: 1px solid #ffc107;
            color: #856404; padding: 12px 16px; border-radius: 8px;
            margin-bottom: 15px; font-size: 0.9rem; display: none;
        }

        .chart-container {
            background: white; border-radius: 20px;
            padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .chart-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        .chart-controls { display: flex; gap: 10px; }
        .export-btn, .theme-toggle {
            padding: 8px 16px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s ease;
        }
        .export-btn { background: #3498db; color: white; }
        .export-btn:hover { background: #2980b9; }
        .theme-toggle { background: #f39c12; color: white; font-size: 1.1rem; }
        .theme-toggle:hover { background: #e67e22; }

        .chart-wrapper { position: relative; height: 400px; width: 100%; }

        .timeline-table {
            background: white; border-radius: 20px;
            padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .timeline-table table { width: 100%; border-collapse: collapse; }
        .timeline-table th {
            background: #34495e; color: white;
            padding: 15px; text-align: right; font-weight: bold;
        }
        .timeline-table td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: right; }
        .timeline-table .year-col           { background: #f8f9fa; font-weight: bold; }
        .timeline-table .deposit-col,
        .timeline-table .total-deposit-col  { background: rgba(52,152,219,0.1); color: #2980b9; }
        .timeline-table .earnings-col,
        .timeline-table .total-earnings-col { background: rgba(39,174,96,0.1);  color: #27ae60; }
        .timeline-table .balance-col        { background: rgba(231,76,60,0.1);  color: #e74c3c; font-weight: bold; }
        .timeline-table .real-value-col     { background: rgba(155,89,182,0.1); color: #9b59b6; }
        .timeline-table tr:hover            { background: #f8f9fa; }

        .hidden { display: none; }

        .note {
            background: #fff3cd; border: 1px solid #ffeaa7;
            color: #856404; padding: 15px; border-radius: 8px;
            margin-top: 20px; font-size: 0.9rem;
        }

        /* Dark theme */
        body.dark-theme { background: #1a1a2e; color: #e0e0e0; }
        body.dark-theme .input-panel,
        body.dark-theme .results-panel,
        body.dark-theme .chart-container,
        body.dark-theme .timeline-table { background: #16213e; color: #e0e0e0; }
        body.dark-theme .form-group input,
        body.dark-theme .form-group select {
            background: #0f3460; color: #e0e0e0; border-color: #444;
        }
        body.dark-theme .timeline-table th { background: #0f3460; }
        body.dark-theme .timeline-table td { border-color: #333; }
        body.dark-theme .timeline-table tr:hover { background: #1a3a5c; }

        @media (max-width: 968px) {
            .calculator-container { grid-template-columns: 1fr; }
            .form-row              { grid-template-columns: 1fr; }
            .summary-cards         { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">

    <link rel="stylesheet" href="navigation.css">
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">ğŸ“ˆ Ù…ÙÙƒØ±Ø© Ù…Ø³ØªØ«Ù…Ø±</a>
            <div class="navbar-menu" id="navbarMenu">
                <a href="index.html"                     class="navbar-item">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <a href="advice.html"                    class="navbar-item calculator">ğŸ’° Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø«Ø±ÙˆØ©</a>
                <a href="salary_calculator.html"         class="navbar-item salary">ğŸ’¼ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø§ØªØ¨</a>
                <a href="zakat_purification.html"        class="navbar-item zakat">ğŸ•Œ Ø§Ù„ØªØ·Ù‡ÙŠØ± ÙˆØ§Ù„Ø²ÙƒØ§Ø©</a>
                <a href="financial_freedom.html"         class="navbar-item fire">ğŸ”¥ Ø§Ù„Ø­Ø±ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a>
                <a href="investor_tips.html"             class="navbar-item tips">âš ï¸ Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</a>
                <a href="snowball_calculator.html"       class="navbar-item calculator">â„ï¸ Ø­Ø§Ø³Ø¨Ø© ÙƒØ±Ø© Ø§Ù„Ø«Ù„Ø¬</a>
                <a href="emergency_fund_calculator.html" class="navbar-item emergency">ğŸ›¡ï¸ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</a>
                <a href="average_calculator.html"        class="navbar-item calculator">ğŸ“Š Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ø±Ø§Ø¡</a>
                <a href="company_valuation.html"         class="navbar-item calculator">ğŸ¢ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø±ÙƒØ©</a>
                <a href="retirement_calculator.html"     class="navbar-item calculator">ğŸ–ï¸ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯</a>
                <a href="portfolio_rating.html"          class="navbar-item calculator">ğŸ›¡ï¸ Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</a>
                <a href="stock_valuation.html"           class="navbar-item valuation">ğŸ“Š ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ù‡Ù…</a>
            </div>
            <button class="navbar-toggle" onclick="toggleNavbar()">â˜°</button>
        </div>
    </nav>

    <script>
        function toggleNavbar() {
            document.getElementById('navbarMenu').classList.toggle('collapsed');
        }
        document.addEventListener('DOMContentLoaded', function () {
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            document.querySelectorAll('.navbar-item').forEach(item => {
                if (item.getAttribute('href') === currentPage ||
                    (currentPage === '' && item.getAttribute('href') === 'index.html')) {
                    item.classList.add('active');
                }
            });
        });
    </script>

    <div class="header">
        <h1>â„ï¸ Ø­Ø§Ø³Ø¨Ø© ÙƒØ±Ø© Ø§Ù„Ø«Ù„Ø¬</h1>
        <p>Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨ ÙˆØ´Ø§Ù‡Ø¯ ÙƒÙŠÙ ØªÙ†Ù…Ùˆ Ø«Ø±ÙˆØªÙƒ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª</p>
    </div>

    <div class="calculator-container">

        <!-- ===== Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== -->
        <div class="input-panel">
            <h2 class="section-title">ğŸ“Š Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</h2>

            <div class="form-group">
                <label for="principal">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø± (Ø±ÙŠØ§Ù„)</label>
                <input type="number" id="principal" value="10000" min="0" step="100">
            </div>

            <div class="form-group">
                <label for="additionalDeposit">Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø±ÙŠØ§Ù„)</label>
                <input type="number" id="additionalDeposit" value="500" min="0" step="50">
            </div>

            <div class="form-group">
                <label for="depositFrequency">ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</label>
                <select id="depositFrequency">
                    <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                    <option value="quarterly">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                    <option value="semiannually">Ù†ØµÙ Ø³Ù†ÙˆÙŠ</option>
                    <option value="annually">Ø³Ù†ÙˆÙŠ</option>
                </select>
            </div>

            <div class="form-group">
                <label>ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="depositTiming" value="beginning" checked>
                        <span>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© (Annuity Due)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="depositTiming" value="end">
                        <span>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© (Ordinary Annuity)</span>
                    </label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="returnRate">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ø¦Ø¯ (%)</label>
                    <input type="number" id="returnRate" value="8" min="0" max="100" step="0.1">
                </div>
                <div class="form-group">
                    <label for="rateType">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø§Ø¦Ø¯</label>
                    <select id="rateType">
                        <option value="annually">Ø³Ù†ÙˆÙŠ</option>
                        <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="years">Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± (Ø³Ù†ÙˆØ§Øª)</label>
                <input type="number" id="years" value="10" min="1" max="50" step="1">
            </div>

            <div class="checkbox-group">
                <label for="dripEnabled">
                    <input type="checkbox" id="dripEnabled">
                    ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© DRIP (Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª)
                </label>
            </div>

            <div class="form-group hidden" id="dividendGroup">
                <label for="dividendYield">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Dividend Yield) %</label>
                <input type="number" id="dividendYield" value="3" min="0" max="20" step="0.1">
            </div>

            <div class="form-group">
                <label for="inflationRate">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¶Ø®Ù… (%) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
                <input type="number" id="inflationRate" value="2" min="0" max="50" step="0.1">
            </div>

            <div class="form-group">
                <label for="depositIncrease">Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ (%) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
                <input type="number" id="depositIncrease" value="0" min="0" max="100" step="1">
            </div>

            <button class="calculate-btn" onclick="calculateCompoundInterest()">
                Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
            </button>

            <div class="note">
                ğŸ’¡ <strong>Ù†ØµÙŠØ­Ø©:</strong> Ø®Ø§ØµÙŠØ© DRIP ØªØ²ÙŠØ¯ Ù…Ù† ÙØ¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨ Ø¹Ø¨Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙÙˆØ±Ø§Ù‹.
            </div>
        </div>

        <!-- ===== Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===== -->
        <div class="results-panel">
            <h2 class="section-title">ğŸ“ˆ Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>

            <div id="warningBox" class="warning-box"></div>

            <div class="summary-cards">
                <div class="summary-card deposits">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</h3>
                    <div class="amount" id="totalDeposits">-</div>
                </div>
                <div class="summary-card earnings">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
                    <div class="amount" id="totalEarnings">-</div>
                </div>
                <div class="summary-card final">
                    <h3>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
                    <div class="amount" id="finalValue">-</div>
                </div>
            </div>

            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¶Ø®Ù…)</h3>
                    <div class="amount" id="realValue">-</div>
                </div>
                <div class="summary-card">
                    <h3>Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (%)</h3>
                    <div class="amount" id="totalReturn">-</div>
                </div>
                <div class="summary-card">
                    <h3>Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨ (CAGR)</h3>
                    <div class="amount" id="cagr">-</div>
                </div>
            </div>

            <div class="summary-cards" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="summary-card final">
                    <h3>Ø³Ù†ÙˆØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙŠÙˆÙ† Ø§Ù„Ø£ÙˆÙ„</h3>
                    <div class="amount" id="yearsToMillion">-</div>
                </div>
                <div class="summary-card earnings">
                    <h3>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h3>
                    <div class="amount" id="earningsRatio">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ===== -->
    <div class="chart-container hidden" id="chartSection">
        <div class="chart-header">
            <h2 class="section-title">ğŸ“Š Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù†Ù…Ùˆ Ø§Ù„Ø«Ø±ÙˆØ©</h2>
            <div class="chart-controls">
                <button class="export-btn" onclick="exportToCSV()">ØªØµØ¯ÙŠØ± CSV</button>
                <button class="export-btn" onclick="exportToPDF()">ØªØµØ¯ÙŠØ± PDF</button>
                <button class="theme-toggle" onclick="toggleChartTheme()">ğŸŒ™</button>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="wealthChart"></canvas>
        </div>
    </div>

    <!-- ===== Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ ===== -->
    <div class="timeline-table hidden" id="timelineSection">
        <h2 class="section-title">ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù†Ù…Ùˆ Ø§Ù„Ø«Ø±ÙˆØ©</h2>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø³Ù†Ø©</th>
                    <th>Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</th>
                    <th>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</th>
                </tr>
            </thead>
            <tbody id="timelineBody"></tbody>
        </table>
    </div>

</div><!-- end .container -->

<script>
/* =========================================================
   Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
   ========================================================= */
let wealthChart = null;
window.currentTimelineData = [];

/* =========================================================
   Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
   ========================================================= */
function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-SA', {
        style: 'currency',
        currency: 'SAR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatPercent(value) {
    return value.toFixed(2) + '%';
}

function getDepositsPerYear(frequency) {
    return { monthly: 12, quarterly: 4, semiannually: 2, annually: 1 }[frequency] ?? 12;
}

/* =========================================================
   Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø­Ø³Ø§Ø¨
   ========================================================= */
function calculateCompoundInterest() {

    // --- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ---
    const principal        = Math.max(parseFloat(document.getElementById('principal').value)        || 0, 0);
    const additionalDeposit= Math.max(parseFloat(document.getElementById('additionalDeposit').value)|| 0, 0);
    const depositFrequency = document.getElementById('depositFrequency').value;
    const depositTiming    = document.querySelector('input[name="depositTiming"]:checked').value;
    const returnRate       = Math.max(parseFloat(document.getElementById('returnRate').value)       || 0, 0);
    const rateType         = document.getElementById('rateType').value;
    const years            = Math.max(parseInt(document.getElementById('years').value)              || 0, 1);
    const dripEnabled      = document.getElementById('dripEnabled').checked;
    const dividendYield    = dripEnabled
                             ? Math.max(parseFloat(document.getElementById('dividendYield').value) || 0, 0)
                             : 0;
    const inflationRate    = Math.max(parseFloat(document.getElementById('inflationRate').value)    || 0, 0);
    const depositIncrease  = Math.max(parseFloat(document.getElementById('depositIncrease').value)  || 0, 0);

    // --- ØªØ­ÙˆÙŠÙ„ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¥Ù„Ù‰ Ù…Ø¹Ø¯Ù„ Ø³Ù†ÙˆÙŠ Ø§Ø³Ù…ÙŠ ---
    // Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø¯Ù„Ø§Ù‹ Ø´Ù‡Ø±ÙŠØ§Ù‹ØŒ Ù†Ø­ÙˆÙ‘Ù„Ù‡ Ø¥Ù„Ù‰ Ø³Ù†ÙˆÙŠ Ù…Ø±ÙƒØ¨
    const annualNominalRate = rateType === 'monthly'
        ? Math.pow(1 + returnRate / 100, 12) - 1
        : returnRate / 100;

    // --- Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¦Ø¯ DRIP Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø³Ù…ÙŠ ---
    // DRIP ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª ØªÙØ¹Ø§Ø¯ Ø§Ø³ØªØ«Ù…Ø§Ø±Ù‡Ø§ØŒ ÙØªÙØ¶Ø§Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ
    const effectiveAnnualRate = dripEnabled
        ? (1 + annualNominalRate) * (1 + dividendYield / 100) - 1
        : annualNominalRate;

    // --- Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØªØ±Ø© (Ø´Ù‡Ø±ÙŠ / Ø±Ø¨Ø¹ÙŠ / Ø¥Ù„Ø®) ---
    const depositsPerYear = getDepositsPerYear(depositFrequency);
    // Ù†Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø¥Ù„Ù‰ Ù…Ø¹Ø¯Ù„ ÙØªØ±Ø© Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
    const periodRate = Math.pow(1 + effectiveAnnualRate, 1 / depositsPerYear) - 1;

    // --- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ ---
    const timelineData = [];
    let balance        = principal;   // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø§Ø±ÙŠ (Ù…Ø¹Ø¯Ù„ Ø§Ø³Ù…ÙŠ)
    let totalDeposited = principal;   // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ø£ÙˆØ¯Ø¹
    let totalEarnings  = 0;           // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©
    let currentPeriodDeposit = additionalDeposit; // Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„ÙØªØ±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©

    // Ø§Ù„Ø³Ù†Ø© 0 - Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    timelineData.push({
        year: 0,
        yearlyDeposits: 0,
        totalDeposits: totalDeposited,
        yearlyEarnings: 0,
        totalEarnings: 0,
        balance: balance,
        realValue: balance   // Ù„Ø§ ØªØ¶Ø®Ù… ÙÙŠ Ø§Ù„Ø³Ù†Ø© ØµÙØ±
    });

    for (let year = 1; year <= years; year++) {

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        // (ÙŠÙØ·Ø¨Ù‚ Ù…Ù† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙØµØ§Ø¹Ø¯Ø§Ù‹)
        if (year > 1 && depositIncrease > 0) {
            currentPeriodDeposit = currentPeriodDeposit * (1 + depositIncrease / 100);
        }

        const balanceAtStartOfYear = balance;
        const annualDepositAmount  = currentPeriodDeposit * depositsPerYear;

        // Ø­Ø³Ø§Ø¨ ÙƒÙ„ ÙØªØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù†Ø©
        for (let p = 0; p < depositsPerYear; p++) {
            if (depositTiming === 'beginning') {
                // Annuity Due: Ø¥ÙŠØ¯Ø§Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ù†Ù…Ùˆ
                balance = (balance + currentPeriodDeposit) * (1 + periodRate);
            } else {
                // Ordinary Annuity: Ù†Ù…Ùˆ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¥ÙŠØ¯Ø§Ø¹
                balance = balance * (1 + periodRate) + currentPeriodDeposit;
            }
        }

        // Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø© = Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø·Ø±ÙˆØ­Ø§Ù‹ Ù…Ù†Ù‡ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª
        const yearlyEarnings = balance - balanceAtStartOfYear - annualDepositAmount;

        totalDeposited += annualDepositAmount;
        totalEarnings  += yearlyEarnings;

        // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¶Ø®Ù… (ØªÙØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø³Ù…ÙŠ ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶)
        const realValue = balance / Math.pow(1 + inflationRate / 100, year);

        timelineData.push({
            year,
            yearlyDeposits: annualDepositAmount,
            totalDeposits: totalDeposited,
            yearlyEarnings,
            totalEarnings,
            balance,
            realValue
        });
    }

    // --- ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ± ---
    window.currentTimelineData = timelineData;

    // --- Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ---
    displayResults(timelineData, principal, years);
    displayChart(timelineData);
    displayTimeline(timelineData);
}

/* =========================================================
   Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
   ========================================================= */
function displayResults(data, principal, years) {
    const last          = data[data.length - 1];
    const totalDeposits = last.totalDeposits;
    const totalEarnings = last.totalEarnings;
    const finalBalance  = last.balance;
    const realValue     = last.realValue;

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ù…Ù‚Ø§Ø±Ù†Ø©Ù‹ Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ø£ÙˆØ¯Ø¹Ù†Ø§Ù‡
    const totalReturn   = ((finalBalance - totalDeposits) / totalDeposits) * 100;

    // CAGR Ù…Ù‚Ø§Ø±Ù†Ø©Ù‹ Ø¨Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙÙ‚Ø· (Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ù…Ø¹ØªØ§Ø¯)
    const cagr = years > 0 ? (Math.pow(finalBalance / Math.max(principal, 1), 1 / years) - 1) * 100 : 0;

    // Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    const earningsRatio = (totalEarnings / finalBalance) * 100;

    document.getElementById('totalDeposits').textContent = formatCurrency(totalDeposits);
    document.getElementById('totalEarnings').textContent = formatCurrency(totalEarnings);
    document.getElementById('finalValue').textContent    = formatCurrency(finalBalance);
    document.getElementById('realValue').textContent     = formatCurrency(realValue);
    document.getElementById('totalReturn').textContent   = formatPercent(totalReturn);
    document.getElementById('cagr').textContent          = formatPercent(cagr);
    document.getElementById('earningsRatio').textContent = formatPercent(earningsRatio);

    // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·: Ù‡Ù„ totalDeposits + totalEarnings â‰ˆ finalBalance?
    const diff = Math.abs(finalBalance - (totalDeposits + totalEarnings));
    const warningBox = document.getElementById('warningBox');
    if (diff > 1) {
        warningBox.style.display = 'block';
        warningBox.textContent   = `âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ©: ÙØ§Ø±Ù‚ Ø­Ø³Ø§Ø¨ÙŠ ØµØºÙŠØ± (${formatCurrency(diff)}) Ù†Ø§ØªØ¬ Ø¹Ù† ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ÙØªØ±Ø§Øª. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØµØ­ÙŠØ­Ø©.`;
    } else {
        warningBox.style.display = 'none';
    }

    // Ø³Ù†ÙˆØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙŠÙˆÙ†
    const milTarget = data.find(d => d.balance >= 1_000_000);
    document.getElementById('yearsToMillion').textContent = milTarget
        ? `${milTarget.year} Ø³Ù†Ø©`
        : 'Ù„Ù… ÙŠØµÙ„ Ù„Ù„Ù…Ù„ÙŠÙˆÙ† Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¯Ø©';
}

/* =========================================================
   Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
   ========================================================= */
function displayChart(data) {
    const ctx      = document.getElementById('wealthChart').getContext('2d');
    const labels   = data.map(d => `Ø§Ù„Ø³Ù†Ø© ${d.year}`);
    const deposits = data.map(d => d.totalDeposits);
    const earnings = data.map(d => d.totalEarnings);
    const total    = data.map(d => d.balance);
    const real     = data.map(d => d.realValue);

    if (wealthChart) wealthChart.destroy();

    wealthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª',
                    data: deposits,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52,152,219,0.1)',
                    borderWidth: 3, fill: true, tension: 0.4
                },
                {
                    label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­',
                    data: earnings,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39,174,96,0.1)',
                    borderWidth: 3, fill: true, tension: 0.4
                },
                {
                    label: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                    data: total,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231,76,60,0.05)',
                    borderWidth: 3, fill: false, tension: 0.4
                },
                {
                    label: 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¶Ø®Ù…)',
                    data: real,
                    borderColor: '#9b59b6',
                    backgroundColor: 'rgba(155,89,182,0.05)',
                    borderWidth: 2, borderDash: [6, 3],
                    fill: false, tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Ù†Ù…Ùˆ Ø§Ù„Ø«Ø±ÙˆØ© Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª (ØªØ£Ø«ÙŠØ± ÙƒØ±Ø© Ø§Ù„Ø«Ù„Ø¬)',
                    font: { size: 16 }
                },
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => ctx.dataset.label + ': ' + formatCurrency(ctx.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: v => formatCurrency(v) }
                }
            }
        }
    });

    document.getElementById('chartSection').classList.remove('hidden');
}

/* =========================================================
   Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ
   ========================================================= */
function displayTimeline(data) {
    const tbody = document.getElementById('timelineBody');
    tbody.innerHTML = '';

    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="year-col">${row.year}</td>
            <td class="deposit-col">${formatCurrency(row.yearlyDeposits)}</td>
            <td class="total-deposit-col">${formatCurrency(row.totalDeposits)}</td>
            <td class="earnings-col">${formatCurrency(row.yearlyEarnings)}</td>
            <td class="total-earnings-col">${formatCurrency(row.totalEarnings)}</td>
            <td class="balance-col"><strong>${formatCurrency(row.balance)}</strong></td>
            <td class="real-value-col">${formatCurrency(row.realValue)}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('timelineSection').classList.remove('hidden');
}

/* =========================================================
   Ø§Ù„ØªØµØ¯ÙŠØ±
   ========================================================= */
function exportToCSV() {
    const data = window.currentTimelineData;
    if (!data || data.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
    }

    const BOM = '\uFEFF'; // Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Excel
    let csv = BOM + 'Ø§Ù„Ø³Ù†Ø©,Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø³Ù†ÙˆÙŠ,Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª,Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠØ©,Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­,Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©\n';
    data.forEach(r => {
        csv += [r.year, r.yearlyDeposits.toFixed(2), r.totalDeposits.toFixed(2),
                r.yearlyEarnings.toFixed(2), r.totalEarnings.toFixed(2),
                r.balance.toFixed(2), r.realValue.toFixed(2)].join(',') + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'snowball_results.csv';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportToPDF() {
    window.print();
}

/* =========================================================
   Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
   ========================================================= */
function toggleChartTheme() {
    const isDark = document.body.classList.toggle('dark-theme');
    updateChartTheme(isDark ? 'dark' : 'light');
}

function updateChartTheme(theme) {
    if (!wealthChart) return;
    const dark = theme === 'dark';
    const textColor = dark ? '#e0e0e0' : '#2c3e50';
    const gridColor = dark ? '#444'    : '#e0e0e0';

    wealthChart.options.plugins.legend.labels.color = textColor;
    ['x', 'y'].forEach(axis => {
        wealthChart.options.scales[axis].ticks.color = textColor;
        wealthChart.options.scales[axis].grid.color  = gridColor;
    });
    wealthChart.update();
}

/* =========================================================
   Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
   ========================================================= */
document.getElementById('dripEnabled').addEventListener('change', function () {
    document.getElementById('dividendGroup').classList.toggle('hidden', !this.checked);
});

window.addEventListener('load', calculateCompoundInterest);
</script>

<script data-goatcounter="https://investornote.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
