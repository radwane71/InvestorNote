<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุญุงุณุจุฉ ุงููููุฉ ุงูุนุงุฏูุฉ ููุฃุณูู | ูููุฑุฉ ูุณุชุซูุฑ</title>
    <link rel="stylesheet" href="navigation.css">
    <link rel="stylesheet" href="dark-theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: linear-gradient(135deg, #e8f0f5 0%, #d0e0e8 100%); min-height: 100vh; padding: 20px; color: #2c3e50; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p  { font-size: 1.1rem; opacity: 0.9; }
        .calculator-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section-title { font-size: 1.4rem; color: #2c3e50; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 3px solid #5a7fb5; }
        .input-group, .select-group, .checkbox-group { margin-bottom: 20px; }
        .input-group label, .select-group label, .checkbox-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #34495e; }
        .input-group input, .select-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; background: white; }
        .input-group input:focus, .select-group select:focus { outline: none; border-color: #5a7fb5; }
        .checkbox-group input[type="checkbox"] { margin-left: 10px; transform: scale(1.2); }
        .field-hint { font-size: 0.78rem; color: #888; margin-top: 5px; line-height: 1.4; }
        .info-box { background: rgba(90,127,181,0.1); border: 2px solid #5a7fb5; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .info-box h4 { color: #4a6fa5; margin-bottom: 10px; }
        .info-box p  { color: #424242; line-height: 1.6; }
        .calculate-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #5a7fb5, #4a6fa5); color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        .calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(90,127,181,0.3); }
        .results-section { display: none; }
        .result-card { background: linear-gradient(135deg, #5a9d7a, #4a8d6a); color: white; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(90,157,122,0.2); margin-bottom: 30px; }
        .result-card h2 { font-size: 1.2rem; margin-bottom: 15px; opacity: 0.9; }
        .result-amount  { font-size: 3rem; font-weight: bold; margin-bottom: 10px; }
        .result-period  { font-size: 1.1rem; opacity: 0.8; }
        .disclaimer-text { background-color: #FFD700; border: 2px solid #FFA500; border-radius: 10px; padding: 15px; margin-top: 15px; color: #000; font-size: 0.8rem; font-weight: bold; line-height: 1.4; }
        .warning-box { background-color: #FFD700; border: 2px solid #FFA500; border-radius: 10px; padding: 20px; margin: 20px 0; color: #000; font-size: 14px; font-weight: bold; line-height: 1.6; display: flex; align-items: flex-start; gap: 10px; }
        .outlier-warning { background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 10px; padding: 15px; margin: 20px 0; color: #856404; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
        .chart-container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 30px; margin-bottom: 30px; }
        .chart-wrapper { position: relative; height: 320px; width: 100%; }
        .advice-card { background: linear-gradient(135deg, #e89d5a, #d88d4a); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(232,157,90,0.2); margin-bottom: 30px; }
        .advice-card h3 { font-size: 1.3rem; margin-bottom: 15px; }
        .advice-card ul { list-style: none; padding: 0; }
        .advice-card li { margin-bottom: 12px; padding-right: 24px; position: relative; line-height: 1.7; }
        .advice-card li::before { content: "โ"; position: absolute; right: 0; font-weight: bold; }
        .breakdown-table { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 30px; }
        .breakdown-table table { width: 100%; border-collapse: collapse; }
        .breakdown-table th { background: #34495e; color: white; padding: 15px; text-align: right; font-weight: bold; }
        .breakdown-table td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: right; }
        .breakdown-table tr:hover { background: #f8f9fa; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .dashboard-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
        .dashboard-card h4  { color: #34495e; margin-bottom: 10px; font-size: 0.9rem; }
        .dashboard-value    { font-size: 1.8rem; font-weight: bold; color: #5a7fb5; }
        .legal-modal { display: flex; position: fixed; z-index: 99999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .legal-modal.hidden { display: none; }
        .legal-modal-content { background: #FFD700; border: 2px solid #FFA500; border-radius: 10px; padding: 30px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .legal-modal-title { font-weight: bold; font-size: 18px; margin-bottom: 20px; }
        .legal-modal-text  { margin-bottom: 25px; line-height: 1.7; }
        .legal-checkbox    { margin-bottom: 20px; }
        .legal-checkbox input { margin-left: 10px; transform: scale(1.2); }
        #enterButton { background: #ccc; color: #000; border: none; padding: 12px 28px; border-radius: 6px; cursor: not-allowed; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        #enterButton.enabled { background: #4a6fa5; color: white; cursor: pointer; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { width: 54px; height: 54px; border: 6px solid #f3f3f3; border-top-color: #5a7fb5; border-radius: 50%; animation: spin 0.9s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .help-icon { display: inline-block; background: none; border: none; cursor: pointer; font-size: 14px; margin-right: 4px; transition: transform 0.2s; }
        .help-icon:hover { transform: scale(1.25); }
        .help-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 3000; }
        .help-modal.hidden { display: none !important; }
        .help-modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
        .help-modal-close { position: absolute; top: 12px; left: 12px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer; line-height: 30px; text-align: center; }
        .help-modal h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1.2rem; }
        .help-modal p  { color: #495057; line-height: 1.7; margin-bottom: 12px; }
        .help-modal ul { margin: 10px 0; padding-right: 20px; }
        .help-modal li { margin-bottom: 6px; color: #495057; }
        .methodology-section { background: white; border-radius: 15px; padding: 30px; margin-top: 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .methodology-intro { font-size: 1.05rem; color: #2c3e50; margin-bottom: 25px; line-height: 1.6; }
        .methodology-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .methodology-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 20px; }
        .methodology-card h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem; }
        .formula { background: #e8f0f5; border: 1px solid #d0e0e8; border-radius: 8px; padding: 14px; margin: 12px 0; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5; }
        .formula-details p   { margin-bottom: 8px; color: #2c3e50; }
        .formula-details ul, .formula-details ol  { margin: 8px 0; padding-right: 20px; }
        .formula-details li  { margin-bottom: 5px; color: #495057; font-size: 0.9rem; }
        .methodology-note { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 20px; }
        .methodology-note h4 { color: #856404; margin-bottom: 12px; }
        .methodology-note li { margin-bottom: 7px; color: #856404; }
        #sensitivityTable { width: 100%; border-collapse: collapse; }
        #sensitivityTable th, #sensitivityTable td { padding: 10px 12px; border: 1px solid #e0e0e0; text-align: center; }
        #sensitivityTable th { background: #34495e; color: white; }
        #sensitivityTable td:first-child { background: #f8f9fa; font-weight: bold; }
        #growthPerpWarning { color: #e74c3c; font-size: 0.85rem; margin-top: 5px; display: none; }
        @media (max-width: 968px) { .calculator-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .result-amount { font-size: 2.5rem; } .methodology-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay hidden"><div class="loading-spinner"></div></div>
<div id="helpModal" class="help-modal hidden">
    <div class="help-modal-content">
        <button class="help-modal-close" onclick="closeHelp()">ร</button>
        <div id="helpContent"></div>
    </div>
</div>
<div id="legalModal" class="legal-modal">
    <div class="legal-modal-content">
        <div class="legal-modal-title">โ๏ธ ุฅูุฑุงุฑ ูุงูููู ููุณุคูููุฉ ูููุฉ</div>
        <div class="legal-modal-text">ูุฐู ุงูุญุงุณุจุฉ ุฃุฏุงุฉ ุชุนููููุฉ ููุญุงูุงุฉ ุงูููุงุฐุฌ ุงููุงููุฉ ุงูุฑูุงุถูุฉ ููุท. ุงููุชุงุฆุฌ ูุฎุฑุฌุงุช ูุนูููุงุช ุญุณุงุจูุฉ ุจูุงุกู ุนูู ูุฏุฎูุงุชูุ ููุง ุชุนูุณ ุงูุณุนุฑ ุงูุณููู ุฃู ุชูุตูุฉ ุงุณุชุซูุงุฑูุฉ. ุงููุตูู ุบูุฑ ูุฑุฎุต ูู ููุฆุฉ ุงูุณูู ุงููุงููุฉ (CMA)ุ ูุงูุงุณุชุฎุฏุงู ููุน ุชุญุช ูุณุคูููุชู ุงููุงููุฉ. ูุง ุชุชุฎุฐ ูุฑุงุฑุงู ุจุงูุจูุน ุฃู ุงูุดุฑุงุก ุจูุงุกู ุนูู ูุฐู ุงูุฃุฑูุงู ุฏูู ุงุณุชุดุงุฑุฉ ูุณุชุดุงุฑ ูุงูู ูุฑุฎุต.</div>
        <div class="legal-checkbox"><label><input type="checkbox" id="legalAccept">ุฃูุฑ ุจุฃููู ูููุช ูุฃูุงูู ุนูู ุฌููุน ุงูุดุฑูุท ูุงููุณุคูููุงุช ุงููุฐููุฑุฉ ุฃุนูุงู</label></div>
        <button id="enterButton" disabled>ููุงูู โ ุฏุฎูู ุงูุญุงุณุจุฉ</button>
    </div>
</div>

<nav class="navbar">
    <div class="navbar-container">
        <a href="index.html" class="navbar-brand">๐ ูููุฑุฉ ูุณุชุซูุฑ</a>
        <button class="navbar-toggle" onclick="toggleNavbar()">โฐ</button>
        <div class="navbar-menu" id="navbarMenu">
            <a href="index.html"                     class="navbar-item">๐ ุงูุฑุฆูุณูุฉ</a>
            <a href="advice.html"                    class="navbar-item calculator">๐ฐ ุตุงูู ุงูุซุฑูุฉ</a>
            <a href="salary_calculator.html"         class="navbar-item salary">๐ผ ุชูุณูู ุงูุฑุงุชุจ</a>
            <a href="zakat_purification.html"        class="navbar-item zakat">๐ ุงูุฒูุงุฉ</a>
            <a href="financial_freedom.html"         class="navbar-item fire">๐ฅ ุงูุญุฑูุฉ ุงููุงููุฉ</a>
            <a href="investor_tips.html"             class="navbar-item tips">โ๏ธ ูุตุงุฆุญ</a>
            <a href="snowball_calculator.html"       class="navbar-item calculator">โ๏ธ ุงูุนุงุฆุฏ ุงููุฑูุจ</a>
            <a href="emergency_fund_calculator.html" class="navbar-item emergency">๐ก๏ธ ุงูุทูุงุฑุฆ</a>
            <a href="average_calculator.html"        class="navbar-item average">๐ ูุชูุณุท ุงูุดุฑุงุก</a>
            <a href="company_valuation.html"         class="navbar-item company">๐ข ุชูููู ุงูุดุฑูุฉ</a>
            <a href="retirement_calculator.html"     class="navbar-item retirement">๐๏ธ ุงูุชูุงุนุฏ</a>
            <a href="portfolio_rating.html"          class="navbar-item portfolio">๐ก๏ธ ุฃูุงู ุงููุญูุธุฉ</a>
            <a href="stock_valuation.html"           class="navbar-item calculator active">๐ ุชูููู ุงูุฃุณูู</a>
            <a href="dca_calculator.html"            class="navbar-item calculator">๐ DCA</a>
            <a href="sell_decision.html"             class="navbar-item calculator">๐ค ูู ุฃุจูุนุ</a>
            <a href="goal_calculator.html"           class="navbar-item calculator">๐ฏ ุงููุฏู ุงูุนูุณู</a>
            <a href="allocation_calculator.html"     class="navbar-item allocation">โ๏ธ ุชูุฒูุน ุงููุญูุธุฉ</a>
        </div>
    </div>
</nav>
<script>
function toggleNavbar(){document.getElementById('navbarMenu').classList.toggle('open');}
document.addEventListener('DOMContentLoaded', function(){
    const page = (window.location.pathname.split('/').pop() || 'index.html').split('?')[0] || 'index.html';
    document.querySelectorAll('.navbar-item').forEach(function(el){
        el.classList.remove('active');
        if ((el.getAttribute('href') || '').split('?')[0] === page) el.classList.add('active');
    });
});
</script>

<div class="container">
    <div class="header">
        <h1>๐ ุญุงุณุจุฉ ุงููููุฉ ุงูุนุงุฏูุฉ ููุฃุณูู</h1>
        <p>ุงุญุณุจ ุงููููุฉ ุงูุนุงุฏูุฉ ููุฃุณูู ุจุงุณุชุฎุฏุงู ููุงุฐุฌ ุงูุชูููู ุงููุงููุฉ ุงููุฎุชููุฉ</p>
    </div>
    <div class="warning-box">
        <span>โ๏ธ</span>
        <div><strong>ุฅูุฑุงุฑ ูุงูููู:</strong> ูุฐู ุงูุญุงุณุจุฉ ุฃุฏุงุฉ ุชุนููููุฉ ุฑูุงุถูุฉ ููุท. ุงููุชุงุฆุฌ ุจูุงุกู ุนูู ูุฏุฎูุงุชู ููุง ุชุนูุณ ุณุนุฑุงู ุณูููุงู ุฃู ุชูุตูุฉ ุงุณุชุซูุงุฑูุฉ. ุงูุงุณุชุฎุฏุงู ุชุญุช ูุณุคูููุชู ุงููุงููุฉ.</div>
    </div>

    <div class="calculator-grid">
        <!-- ===== ุจุทุงูุฉ ุงููุฏุฎูุงุช ุงูุฃุณุงุณูุฉ ===== -->
        <div class="card">
            <h2 class="section-title">๐ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</h2>

            <div class="select-group">
                <label>ููุน ุงูุดุฑูุฉ <button class="help-icon" onclick="showHelp('companyType')">โน๏ธ</button></label>
                <select id="companyType" onchange="toggleCompanyType()">
                    <option value="normal">ุดุฑูุฉ ุนุงุฏูุฉ</option>
                    <option value="reit">ุตูุฏูู ุฑูุช ุนูุงุฑู</option>
                </select>
            </div>

            <!-- ูุฏุฎูุงุช ุงูุดุฑูุฉ ุงูุนุงุฏูุฉ -->
            <div id="normalCompanyInputs">
                <div class="input-group">
                    <label>ุงูุฑุจุญ ููุณูู (EPS) <button class="help-icon" onclick="showHelp('eps')">โน๏ธ</button></label>
                    <input type="number" id="eps" value="5.0" step="0.01">
                </div>
                <div class="input-group">
                    <label>ุงูุชุฏูู ุงูููุฏู ุงูุญุฑ ููุณูู (FCF) <button class="help-icon" onclick="showHelp('fcf')">โน๏ธ</button></label>
                    <input type="number" id="fcf" value="3.0" step="0.1">
                </div>
                <!-- โ ุฅุตูุงุญ: ุงุณุชุจุฏุงู ุญููู ุงูููุฏ ูุงูุฏููู ุจุญูู ูุงุญุฏ "ุงูุฏูู ุงูุตุงูู ููุณูู" -->
                <div class="input-group">
                    <label>ุงูุฏูู ุงูุตุงูู ููุณูู <button class="help-icon" onclick="showHelp('netDebt')">โน๏ธ</button></label>
                    <input type="number" id="netDebt" value="0" step="0.1">
                    <p class="field-hint">= (ุฅุฌูุงูู ุงูุฏููู โ ุงูููุฏ ูุงููุนุงุฏูุงุช) รท ุนุฏุฏ ุงูุฃุณูู. ุฃุฏุฎู ูููุฉ ุณุงูุจุฉ ุฅุฐุง ูุงูุช ุงูุดุฑูุฉ ููุฏูุฉ ุตุงููุฉ (cash-rich).</p>
                </div>
            </div>

            <!-- ูุฏุฎูุงุช ุงูุฑูุช -->
            <div id="reitInputs" style="display:none;">
                <!-- โ ุฅุตูุงุญ: ุชูุถูุญ ูุญุฏุฉ NAV -->
                <div class="input-group">
                    <label>ุตุงูู ูููุฉ ุงูุฃุตูู ุงูุฅุฌูุงููุฉ NAV (ุจุงูุฑูุงู) <button class="help-icon" onclick="showHelp('nav')">โน๏ธ</button></label>
                    <input type="number" id="nav" value="500000000" step="1000000" min="0">
                    <p class="field-hint">ุฃุฏุฎู ุงููููุฉ ุงูุฅุฌูุงููุฉ ุจุงูุฑูุงู. ูุซุงู: ุตูุฏูู ุจุฃุตูู 500 ููููู โ ุฃุฏุฎู 500000000</p>
                </div>
                <div class="input-group">
                    <label>ุนุฏุฏ ูุญุฏุงุช ุงูุฑูุช <button class="help-icon" onclick="showHelp('totalUnits')">โน๏ธ</button></label>
                    <input type="number" id="totalUnits" value="10000000" step="100000" min="1" placeholder="ูุซุงู: 10000000">
                </div>
                <div class="input-group">
                    <label>ุงูุชุฏููุงุช ุงูููุฏูุฉ ุงูุชุดุบูููุฉ ูููุญุฏุฉ (FFO) <button class="help-icon" onclick="showHelp('ffo')">โน๏ธ</button></label>
                    <input type="number" id="ffo" value="8.0" step="0.1" min="0">
                </div>
                <!-- โ ุฅุตูุงุญ: ุฅุถุงูุฉ ูุถุงุนู P/FFO ุจุฏูุงู ูู Cap Rate ูุญุฏู -->
                <div class="input-group">
                    <label>ูุถุงุนู P/FFO ุงูุนุงุฏู <button class="help-icon" onclick="showHelp('pffoMultiple')">โน๏ธ</button></label>
                    <input type="number" id="pffoMultiple" value="12" step="0.5" min="1" max="40">
                    <p class="field-hint">ูุถุงุนู P/FFO ุงููุนุชุงุฏ ููุฑูุชุงุช 10โ16x. ุงุณุชุฎุฏู ูุชูุณุท ุงููุทุงุน ููุฑุฌุน.</p>
                </div>
                <div class="input-group">
                    <label>ูุนุฏู ุงูุฑุณููุฉ ุงูุนูุงุฑูุฉ Cap Rate (%) <button class="help-icon" onclick="showHelp('capRate')">โน๏ธ</button></label>
                    <input type="number" id="capRate" value="8.0" step="0.1" min="0.1" max="30">
                    <p class="field-hint">ููุณุชุฎุฏู ูุญุณุงุจ ูููุฉ ุงูุฃุตูู ุงูุนูุงุฑูุฉ ุจุทุฑููุฉ NOI รท Cap Rate ููููุงุณ ุซุงููู.</p>
                </div>
                <div class="input-group">
                    <label>ุฅุฌูุงูู ุงูุฏููู (ุจุงูุฑูุงู) <button class="help-icon" onclick="showHelp('totalDebt')">โน๏ธ</button></label>
                    <input type="number" id="totalDebt" value="0" step="1000" min="0">
                </div>
            </div>

            <div class="input-group">
                <label>ูุณุจุฉ ุงูููู ููุณููุงุช 5 ุงููุงุฏูุฉ (%) <button class="help-icon" onclick="showHelp('growth5yr')">โน๏ธ</button></label>
                <input type="number" id="growth5yr" value="10.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ูุณุจุฉ ุงูููู ุงูุฏุงุฆู (%) โ max 3% <button class="help-icon" onclick="showHelp('growthPerp')">โน๏ธ</button></label>
                <input type="number" id="growthPerp" value="2.5" step="0.1" min="0" max="3" oninput="validateGrowthPerp()">
                <div id="growthPerpWarning">โ๏ธ ุงูููู ุงูุฏุงุฆู ูุง ูุชุฌุงูุฒ 3% โ ุชู ุงูุชุตุญูุญ ุชููุงุฆูุงู</div>
            </div>
            <div class="input-group">
                <label>ูุนุฏู ุงูุฎุตู WACC (%) <button class="help-icon" onclick="showHelp('discountRate')">โน๏ธ</button></label>
                <input type="number" id="discountRate" value="8.0" step="0.1" min="0.1">
            </div>
            <div class="input-group">
                <label>ููุฑุฑ ุงูุฑุจุญูุฉ ุงูุญุงูู P/E <button class="help-icon" onclick="showHelp('currentPe')">โน๏ธ</button></label>
                <input type="number" id="currentPe" value="15.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ููุฑุฑ ุฑุจุญูุฉ ุงููุทุงุน <button class="help-icon" onclick="showHelp('sectorPe')">โน๏ธ</button></label>
                <input type="number" id="sectorPe" value="18.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ุชูุฒูุนุงุช ุงูุฃุฑุจุงุญ ุงูุณูููุฉ ููุณูู <button class="help-icon" onclick="showHelp('dividends')">โน๏ธ</button></label>
                <input type="number" id="dividends" value="1.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ุงููููุฉ ุงูุฏูุชุฑูุฉ ููุณูู <button class="help-icon" onclick="showHelp('bookValue')">โน๏ธ</button></label>
                <input type="number" id="bookValue" value="20.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ุนุงุฆุฏ ุงูุณูุฏุงุช ุงูุญููููุฉ 10 ุณููุงุช (%) <button class="help-icon" onclick="showHelp('bondYield')">โน๏ธ</button></label>
                <input type="number" id="bondYield" value="6.5" step="0.1" min="0.1" max="30">
            </div>
            <div class="input-group">
                <label>ุงูุณุนุฑ ุงูุญุงูู ููุณูู <button class="help-icon" onclick="showHelp('currentPrice')">โน๏ธ</button></label>
                <input type="number" id="currentPrice" value="50.0" step="0.1" min="0">
            </div>
        </div>

        <!-- ===== ุจุทุงูุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ ===== -->
        <div class="card">
            <h2 class="section-title">โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</h2>

            <div class="checkbox-group">
                <label><input type="checkbox" id="useWacc">ุญุณุงุจ WACC ุชููุงุฆูุงู <button class="help-icon" onclick="showHelp('useWacc')">โน๏ธ</button></label>
            </div>
            <div id="waccInputs" style="display:none;">
                <div class="input-group">
                    <label>ูุนุฏู ุงูุนุงุฆุฏ ุงูุฎุงูู ูู ุงููุฎุงุทุฑ (%) <button class="help-icon" onclick="showHelp('riskFree')">โน๏ธ</button></label>
                    <input type="number" id="riskFree" value="4.0" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label>ุจูุชุง Beta <button class="help-icon" onclick="showHelp('beta')">โน๏ธ</button></label>
                    <input type="number" id="beta" value="1.2" step="0.05" min="0">
                </div>
                <div class="input-group">
                    <label>ุนุงุฆุฏ ุงูุณูู ุงููุชููุน (%) <button class="help-icon" onclick="showHelp('marketReturn')">โน๏ธ</button></label>
                    <input type="number" id="marketReturn" value="8.0" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label>ุชูููุฉ ุงูุฏูู (%) <button class="help-icon" onclick="showHelp('debtCost')">โน๏ธ</button></label>
                    <input type="number" id="debtCost" value="5.0" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label>ูุนุฏู ุงูุถุฑูุจุฉ (%) <button class="help-icon" onclick="showHelp('taxRate')">โน๏ธ</button></label>
                    <input type="number" id="taxRate" value="20.0" step="0.1" min="0" max="100">
                </div>
                <div class="input-group">
                    <label>ูุณุจุฉ ุงูุฏูู ุฅูู ุญููู ุงูููููุฉ D/E <button class="help-icon" onclick="showHelp('debtEquity')">โน๏ธ</button></label>
                    <input type="number" id="debtEquity" value="0.5" step="0.05" min="0">
                </div>
            </div>

            <div class="select-group">
                <label>ุงูุณููุงุฑูู <button class="help-icon" onclick="showHelp('scenario')">โน๏ธ</button></label>
                <select id="scenario">
                    <option value="realistic">ูุงูุนู</option>
                    <option value="optimistic">ูุชูุงุฆู (+2%)</option>
                    <option value="conservative">ูุญุชุงุท (-2%)</option>
                </select>
            </div>

            <div class="input-group">
                <label>ููุฑุฑ ุงููููุฉ ุงูุฏูุชุฑูุฉ ุงูุนุงุฏู P/B <button class="help-icon" onclick="showHelp('fairPb')">โน๏ธ</button></label>
                <input type="number" id="fairPb" value="1.5" step="0.1" min="0.1">
            </div>

            <h3 class="section-title" style="margin-top:20px;">๐ฏ ูุทุงูุงุช ุชุญููู ุงูุญุณุงุณูุฉ (DCF)</h3>
            <div class="input-group">
                <label>ุงูุญุฏ ุงูุฃุฏูู ููููู (%) <button class="help-icon" onclick="showHelp('growthMin')">โน๏ธ</button></label>
                <input type="number" id="growthMin" value="5.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ุงูุญุฏ ุงูุฃุนูู ููููู (%) <button class="help-icon" onclick="showHelp('growthMax')">โน๏ธ</button></label>
                <input type="number" id="growthMax" value="15.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ุงูุญุฏ ุงูุฃุฏูู ููุฎุตู (%) <button class="help-icon" onclick="showHelp('discountMin')">โน๏ธ</button></label>
                <input type="number" id="discountMin" value="6.0" step="0.1" min="0.1">
            </div>
            <div class="input-group">
                <label>ุงูุญุฏ ุงูุฃุนูู ููุฎุตู (%) <button class="help-icon" onclick="showHelp('discountMax')">โน๏ธ</button></label>
                <input type="number" id="discountMax" value="12.0" step="0.1" min="0.1">
            </div>

            <h3 class="section-title" style="margin-top:20px;">๐ ุงููุณุจ ุงููุงููุฉ (ููุนุฑุถ)</h3>
            <div class="input-group">
                <label>ูุณุจุฉ ุงูุฏูู (%) <button class="help-icon" onclick="showHelp('debtRatio')">โน๏ธ</button></label>
                <input type="number" id="debtRatio" value="30.0" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ูุณุจุฉ ุงูุณูููุฉ <button class="help-icon" onclick="showHelp('liquidityRatio')">โน๏ธ</button></label>
                <input type="number" id="liquidityRatio" value="1.5" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ุฌูุฏุฉ ุงูุฃุฑุจุงุญ ROE (%) <button class="help-icon" onclick="showHelp('earningsQuality')">โน๏ธ</button></label>
                <input type="number" id="earningsQuality" value="15.0" step="0.1" min="0">
            </div>

            <button class="calculate-btn" onclick="calculateFairValue()">ุงุญุณุจ ุงููููุฉ ุงูุนุงุฏูุฉ</button>
        </div>
    </div>

    <!-- ===== ูุณู ุงููุชุงุฆุฌ ===== -->
    <div class="results-section" id="resultsSection">

        <div class="result-card">
            <h2>๐ข ูููุฉ ุงูููุดุฃุฉ (Enterprise Value)</h2>
            <div class="result-amount" id="enterpriseValueRange">-</div>
            <div class="result-period"  id="enterpriseValueDetails">-</div>
            <p class="disclaimer-text">โ๏ธ ูุฐู ุงููููุฉ ุฅุฌูุงูู ูููุฉ ุงูุดุฑูุฉ ูุจู ุฎุตู ุงูุฏููู ุงูุตุงููุฉ</p>
        </div>

        <div class="result-card">
            <h2>๐ฐ ุงููููุฉ ุงูุนุงุฏูุฉ ููุณูู ุงููุงุญุฏ</h2>
            <div class="result-amount" id="fairValueRange">-</div>
            <div class="result-period"  id="fairValueDetails">-</div>
            <p class="disclaimer-text">โ๏ธ ุฃุฏุงุฉ ุชุนููููุฉ ุฑูุงุถูุฉ ููุท โ ููุณุช ุชูุตูุฉ ุงุณุชุซูุงุฑูุฉ</p>
        </div>

        <div id="outlierWarning" class="outlier-warning" style="display:none;"></div>

        <div class="breakdown-table">
            <h2 class="section-title">๐ ูุชุงุฆุฌ ุงูููุงุฐุฌ</h2>
            <table>
                <thead><tr><th>ุงููููุฐุฌ</th><th>ุงููููุฉ ุงูุนุงุฏูุฉ</th><th>ุงููุถุน</th></tr></thead>
                <tbody id="modelsTable"></tbody>
            </table>
        </div>

        <div class="chart-container">
            <h2 class="section-title">๐ ููุงุฑูุฉ ุงูููุงุฐุฌ</h2>
            <div class="chart-wrapper"><canvas id="modelsChart"></canvas></div>
        </div>

        <div class="breakdown-table">
            <h2 class="section-title">๐ ุชุญููู ุงูุญุณุงุณูุฉ โ DCF (ุงูููู \ ูุนุฏู ุงูุฎุตู)</h2>
            <table id="sensitivityTable"></table>
        </div>

        <div class="dashboard">
            <div class="dashboard-card"><h4>ูุณุจุฉ ุงูุฏูู</h4><div class="dashboard-value" id="dashboardDebt">-</div></div>
            <div class="dashboard-card"><h4>ูุณุจุฉ ุงูุณูููุฉ</h4><div class="dashboard-value" id="dashboardLiquidity">-</div></div>
            <div class="dashboard-card"><h4>ุฌูุฏุฉ ุงูุฃุฑุจุงุญ ROE</h4><div class="dashboard-value" id="dashboardEarnings">-</div></div>
            <div class="dashboard-card"><h4>ูุงูุด ุงูุฃูุงู</h4><div class="dashboard-value" id="dashboardMargin">-</div></div>
        </div>
    </div>

    <!-- ===== ูุณู ุงููููุฌูุฉ ===== -->
    <div class="methodology-section">
        <h2 class="section-title">๐ ููู ุชุนูู ุงูุญุงุณุจุฉุ</h2>
        <p class="methodology-intro">ูุชุนุฒูุฒ ุงูุดูุงููุฉุ ููุถุญ ุฌููุน ุงููุนุงุฏูุงุช ูุงูููุงุฐุฌ ุงููุงููุฉ ุงููุณุชุฎุฏูุฉ:</p>
        <div class="methodology-grid">
            <div class="methodology-card">
                <h3>๐ DCF โ ุงูุชุฏูู ุงูููุฏู ุงููุฎุตูู</h3>
                <div class="formula">ุงููููุฉ = ฮฃ FCF<sub>t</sub>/(1+r)<sup>t</sup> + TV/(1+r)<sup>10</sup><br>TV = FCF<sub>10</sub> ร (1+g) / (r โ g)<br>ูููุฉ ุงูุณูู = EV โ ุงูุฏูู ุงูุตุงูู ููุณูู</div>
                <div class="formula-details">
                    <p>ุงูุณููุงุช 1-5: FCF ูููู ุจู growth_5yr | ุงูุณููุงุช 6-10: ูููู ุจู growth_perp</p>
                    <p>โ ุงูุฏูู ุงูุตุงูู ููุทุฑุญ ูู EV ููุญุตูู ุนูู ูููุฉ ุญููู ุงูููููุฉ ุงููุนููุฉ</p>
                </div>
            </div>
            <div class="methodology-card">
                <h3>๐ ูุนุงุฏูุฉ ุฌุฑุงูุงู ุงููุนุฏูุฉ</h3>
                <div class="formula">V = (EPS ร min(8.5 + 2g, 25) ร 4.4) / Y</div>
                <div class="formula-details">
                    <p>g = ูุณุจุฉ ุงูููู ุงููุชููุน (%) | Y = ุนุงุฆุฏ ุงูุณูุฏุงุช 10 ุณููุงุช (%)</p>
                    <p>ุงูุญุฏ ุงูุฃูุตู ูููุถุงุนู 25 ูููุน ุงููุจุงูุบุฉ ุจุดุฑูุงุช ุงูููู ุงูุณุฑูุน</p>
                </div>
            </div>
            <div class="methodology-card">
                <h3>๐ฐ ูููุฐุฌ P/E</h3>
                <div class="formula">ุงููููุฉ = EPS ร min(P/E ุงููุทุงุน, 40)</div>
                <div class="formula-details"><p>ุงูุญุฏ ุงูุฃูุตู 40 ูููุน ุงูุชุถุฎู ูู ุงูุชูููู</p></div>
            </div>
            <div class="methodology-card">
                <h3>๐ฑ ูููุฐุฌ ุฌูุฑุฏูู (Gordon Growth)</h3>
                <div class="formula">V = Dโ / (r โ g) = Div ร (1+g) / (rโg)</div>
                <div class="formula-details"><p>ููุทุจู ููุท ุฅุฐุง ูุงู r > g | ููุดุฑูุงุช ุฐุงุช ุงูุชูุฒูุนุงุช ุงููุณุชูุฑุฉ</p></div>
            </div>
            <div class="methodology-card">
                <h3>๐ ุงููููุฉ ุงูุฏูุชุฑูุฉ ุงููุนุฏูุฉ</h3>
                <div class="formula">V = ุงููููุฉ ุงูุฏูุชุฑูุฉ ร P/B ุงูุนุงุฏู</div>
                <div class="formula-details"><p>ูุนูุณ ุงููููุฉ ุงููุญุงุณุจูุฉ ูุน ูุฑุงุนุงุฉ ุฌูุฏุฉ ุงูุฃุตูู</p></div>
            </div>
            <div class="methodology-card">
                <h3>๐ข ุชูููู ุงูุฑูุช</h3>
                <div class="formula">NAV ูููุญุฏุฉ = (NAV โ ุงูุฏููู) รท ุนุฏุฏ ุงููุญุฏุงุช<br>ูููุฉ P/FFO = FFO ร ูุถุงุนู P/FFO</div>
                <div class="formula-details">
                    <p>โ P/FFO ูู ุงููููุงุณ ุงูุตุญูุญ ููุฑูุชุงุช โ ูุดุงุจู ููู P/E ููุฃุณูู ุงูุนุงุฏูุฉ</p>
                    <p>NAV รท Cap Rate ููุนุทู ููููุงุณ ุซุงููู ููุชุญูู ููุท</p>
                </div>
            </div>
            <div class="methodology-card">
                <h3>โ๏ธ WACC</h3>
                <div class="formula">WACC = (E/V ร Re) + (D/V ร Rd ร (1โT))<br>Re = Rf + ฮฒ ร (Rm โ Rf)</div>
                <div class="formula-details"><p>Re = ุชูููุฉ ุญููู ุงูููููุฉ (CAPM) | Rd = ุชูููุฉ ุงูุฏูู | T = ุงูุถุฑูุจุฉ</p></div>
            </div>
        </div>
        <div class="methodology-note">
            <h4>โ๏ธ ุญุฏูุฏ ุงูุงุณุชุฎุฏุงู:</h4>
            <ul>
                <li>ุงูุญุงุณุจุฉ ุฃุฏุงุฉ ุชุนููููุฉ โ ููุณุช ุชูุตูุฉ ุงุณุชุซูุงุฑูุฉ ุจุฃู ุดูู</li>
                <li>ุฌูุฏุฉ ุงููุชุงุฆุฌ ุชุนุชูุฏ ุนูู ุฌูุฏุฉ ุงููุฏุฎูุงุช (GIGO)</li>
                <li>ุงูููุงุฐุฌ ุชุณุชุจุนุฏ ุงูุดุฑูุงุช ุงูุฎุงุณุฑุฉ (EPS โค 0) ูู ุญุณุงุจุงุช ุฌุฑุงูุงู ู P/E</li>
                <li>ูููุฐุฌ Gordon ูุณุชุจุนุฏ ุชููุงุฆูุงู ุฅุฐุง ูุงูุช ุงูุชูุฒูุนุงุช = 0 ุฃู r โค g</li>
                <li>ุงูุฏูู ุงูุตุงูู ููุณูู ููุทุฑุญ ูู ูููุฉ DCF โ ุถุน ูููุฉ ุณุงูุจุฉ ููุดุฑูุงุช ุงูููุฏูุฉ</li>
                <li>ุงูููู ุงูุดุงุฐุฉ (outliers) ูุชู ุฅุจูุงุบู ุนููุง ุชููุงุฆูุงู</li>
            </ul>
        </div>
    </div>
</div>

<script>
let modelsChart = null;

// ===== Help System =====
const helpContent = {
    eps:         { title: 'ุงูุฑุจุญ ููุณูู (EPS)',         body: '<p>ุตุงูู ุฑุจุญ ุงูุดุฑูุฉ รท ุนุฏุฏ ุงูุฃุณูู. ูุณุชุฎุฏู ูู ููุงุฐุฌ ุฌุฑุงูุงู ู P/E.</p><p><strong>ุฃูู ุชุฌุฏู:</strong> ูููุน ุชุฏุงูู โ ุงูุจูุงูุงุช ุงููุงููุฉ โ ุงูุฑุจุญ ููุณูู.</p>' },
    fcf:         { title: 'ุงูุชุฏูู ุงูููุฏู ุงูุญุฑ ููุณูู',  body: '<p>ุงูููุฏ ุงููุชุงุญ ุจุนุฏ ุงููููุงุช ุงูุชุดุบูููุฉ ูุงูุงุณุชุซูุงุฑูุฉ. ุงูุฃุณุงุณ ูู ูููุฐุฌ DCF.</p><p>ุญุณุงุจ: ุงูุชุฏูู ุงูุชุดุบููู โ ูููุงุช ุฑุฃุณ ุงููุงู</p>' },
    // โ ุญูู ุฌุฏูุฏ
    netDebt:     { title: 'ุงูุฏูู ุงูุตุงูู ููุณูู',        body: '<p>= (ุฅุฌูุงูู ุงูุฏููู โ ุงูููุฏ ูุงููุนุงุฏูุงุช) รท ุนุฏุฏ ุงูุฃุณูู.</p><p>ููุทุฑุญ ูู ูููุฉ ุงูููุดุฃุฉ (EV) ูููุตูู ุฅูู ูููุฉ ุญููู ุงูููููุฉ ุงููุนููุฉ.</p><p>ุฅุฐุง ูุงู ุงูููุฏ ุฃูุจุฑ ูู ุงูุฏูููุ ุฃุฏุฎู ูููุฉ ุณุงูุจุฉ (ูุซุงู: โ5).</p>' },
    nav:         { title: 'NAV โ ุตุงูู ูููุฉ ุงูุฃุตูู',   body: '<p>ุฅุฌูุงูู ูููุฉ ุฃุตูู ุงูุฑูุช ุจุงูุณูู ุจุงูุฑูุงู. ูููุณู ุนูู ุนุฏุฏ ุงููุญุฏุงุช ุจุนุฏ ุทุฑุญ ุงูุฏููู.</p><p>ุฃุฏุฎู ุงููููุฉ ุงูุฅุฌูุงููุฉ ุจุงูุฑูุงู ูุงููุงู (ูุซุงู: 500000000 ูู 500 ููููู).</p>' },
    totalUnits:  { title: 'ุนุฏุฏ ูุญุฏุงุช ุงูุฑูุช',           body: '<p>ุนุฏุฏ ุงููุญุฏุงุช ุงูุงุณุชุซูุงุฑูุฉ ุงููุตุฏุฑุฉ. ููุณุชุฎุฏู ูุชุญููู NAV ุงูุฅุฌูุงูู ุฅูู NAV ูููุญุฏุฉ.</p>' },
    ffo:         { title: 'FFO โ ุงูุชุฏูู ุงูููุฏู ุงูุชุดุบููู ูููุญุฏุฉ', body: '<p>ูุนูุงุฑ ุฃุณุงุณู ูุชูููู ุงูุฑูุชุงุช. ูููุณ ุงูุชุฏูู ุงูููุฏู ุจุนุฏ ุฎุตู ุงูุฏููู ูุจุฏูู ุงูุงุณุชููุงู.</p>' },
    // โ ุญูู ุฌุฏูุฏ
    pffoMultiple:{ title: 'ูุถุงุนู P/FFO ุงูุนุงุฏู',        body: '<p>ูุดุจู P/E ููุฃุณูู ุงูุนุงุฏูุฉ. ููุญุฏุฏ ูู ูุฏูุน ุงูุณูู ููุงุจู ูู ุฑูุงู ูู FFO.</p><p>ุงูุฑูุชุงุช ุงูุณุนูุฏูุฉ: 10โ14x ุนุงุฏุฉ. ุฑูุชุงุช ุงูููู: 14โ18x.</p>' },
    capRate:     { title: 'Cap Rate โ ูุนุฏู ุงูุฑุณููุฉ ุงูุนูุงุฑูุฉ', body: '<p>ูุณุจุฉ ุฏุฎู ุงูุฅูุฌุงุฑ ุงูุตุงูู ุฅูู ูููุฉ ุงูุนูุงุฑ. ููุณุชุฎุฏู ููููุงุณ ุซุงููู ููุชุญูู.</p>' },
    totalDebt:   { title: 'ุฅุฌูุงูู ุงูุฏููู',              body: '<p>ุฅุฌูุงูู ุฏููู ุงูุฑูุช ุจุงูุฑูุงู. ููุทุฑุญ ูู NAV ุงูุฅุฌูุงูู ูุญุณุงุจ ุตุงูู ุงููููุฉ ูููุณุชุซูุฑูู.</p>' },
    growth5yr:   { title: 'ูุณุจุฉ ุงูููู 5 ุณููุงุช',        body: '<p>ุงูููู ุงูุณููู ุงููุชููุน ููุณููุงุช ุงูุฎูุณ ุงููุงุฏูุฉ. ูุคุซุฑ ุจุดูู ูุจูุฑ ุนูู ูููุฉ DCF ูุฌุฑุงูุงู.</p><p>ูู ูุงูุนูุงู โ ูุนุธู ุงูุดุฑูุงุช ุงููุงุถุฌุฉ 5-12%.</p>' },
    growthPerp:  { title: 'ุงูููู ุงูุฏุงุฆู',               body: '<p>ุงูููู ุงููุชููุน ุจุนุฏ ุงูุณูุฉ 10 ุฅูู ุงูุฃุจุฏ. ูุฌุจ ุฃู ูููู ุฃูู ูู WACC ูุฃูู ูู ููู ุงูุงูุชุตุงุฏ. ุนุงุฏุฉ 2-3%.</p>' },
    discountRate:{ title: 'WACC โ ูุนุฏู ุงูุฎุตู',         body: '<p>ุงูุนุงุฆุฏ ุงููุทููุจ ูู ุงููุณุชุซูุฑูู. ุดุฑูุฉ ูุณุชูุฑุฉ โ 8%ุ ูุฎุงุทุฑุฉ ุนุงููุฉ โ 12%.</p>' },
    currentPe:   { title: 'P/E ุงูุญุงูู',                body: '<p>ุณุนุฑ ุงูุณูู รท EPS. ููููุงุฑูุฉ ูุน P/E ุงููุทุงุน.</p>' },
    sectorPe:    { title: 'P/E ุงููุทุงุน',                body: '<p>ูุชูุณุท P/E ููุดุฑูุงุช ุงูููุงูุณุฉ. ุฃุณุงุณ ูููุฐุฌ ุงูุชูููู ุงููุณุจู.</p>' },
    dividends:   { title: 'ุงูุชูุฒูุนุงุช ุงูุณูููุฉ',          body: '<p>ุงูุชูุฒูุนุงุช ุงูููุฏูุฉ ููุณูู ุณูููุงู. ูุณุชุฎุฏูู ูููุฐุฌ Gordon.</p>' },
    bookValue:   { title: 'ุงููููุฉ ุงูุฏูุชุฑูุฉ',            body: '<p>ุญููู ุงูููููุฉ รท ุนุฏุฏ ุงูุฃุณูู. ููุถุฑุจ ูู P/B ุงูุนุงุฏู.</p>' },
    bondYield:   { title: 'ุนุงุฆุฏ ุงูุณูุฏุงุช ุงูุญููููุฉ',      body: '<p>ููุณุชุฎุฏู ูู ูุนุงุฏูุฉ ุฌุฑุงูุงู. ูู ุงูุณุนูุฏูุฉ ูุชุฑุงูุญ 5.5-7.5%.</p>' },
    currentPrice:{ title: 'ุงูุณุนุฑ ุงูุญุงูู',               body: '<p>ููุณุชุฎุฏู ูุญุณุงุจ ูุงูุด ุงูุฃูุงู: (ุงููููุฉ ุงูุนุงุฏูุฉ โ ุงูุณุนุฑ) รท ุงููููุฉ ุงูุนุงุฏูุฉ.</p>' },
    useWacc:     { title: 'ุญุณุงุจ WACC ุชููุงุฆูุงู',        body: '<p>ูุญุณุจ WACC ูู CAPM + ุชูููุฉ ุงูุฏูู.</p>' },
    riskFree:    { title: 'ูุนุฏู ุงูุฎุงูู ูู ุงููุฎุงุทุฑ',    body: '<p>ุนุงุฏุฉู ุนุงุฆุฏ ุงูุณูุฏุงุช ุงูุญููููุฉ 10 ุณููุงุช.</p>' },
    beta:        { title: 'Beta โ ูุนุงูู ุงููุฎุงุทุฑ',       body: '<p>ฮฒ<1: ุฃูู ุชููุจุงู | ฮฒ=1: ูุน ุงูุณูู | ฮฒ>1: ุฃูุซุฑ ุชููุจุงู.</p>' },
    marketReturn:{ title: 'ุนุงุฆุฏ ุงูุณูู',                 body: '<p>ูุชูุณุท ุงูุนุงุฆุฏ ุงูุณููู ููุณูู. ููุชุงุณู 7-10% ุชุงุฑูุฎูุงู.</p>' },
    debtCost:    { title: 'ุชูููุฉ ุงูุฏูู',                body: '<p>ูุนุฏู ุงููุงุฆุฏุฉ ุนูู ูุฑูุถ ุงูุดุฑูุฉ. ููุทุจู ุนููู ุงูููุฑ ุงูุถุฑูุจู.</p>' },
    taxRate:     { title: 'ูุนุฏู ุงูุถุฑูุจุฉ',               body: '<p>20% ููุดุฑูุงุช ุงูุณุนูุฏูุฉุ 25% ููุฃุฌูุจูุฉ.</p>' },
    debtEquity:  { title: 'D/E',                        body: '<p>ูุญุฏุฏ ุฃูุฒุงู ุงูุฏูู ูุญููู ุงูููููุฉ ูู WACC.</p>' },
    scenario:    { title: 'ุงูุณููุงุฑูู',                  body: '<p>ูุนุฏูู ูุณุจ ุงูููู: ูุชูุงุฆู +2% | ูุญุชุงุท -2%.</p>' },
    fairPb:      { title: 'P/B ุงูุนุงุฏู',                body: '<p>1.0 ูุฃุตูู ุนุงุฏูุฉ | 1.5 ูุฃุตูู ุฌูุฏุฉ | 2+ ูุฃุตูู ููุชุงุฒุฉ.</p>' },
    growthMin:   { title: 'ุงูุญุฏ ุงูุฃุฏูู ููููู',         body: '<p>ุฃุฏูู ููู ูู ุฌุฏูู ุงูุญุณุงุณูุฉ.</p>' },
    growthMax:   { title: 'ุงูุญุฏ ุงูุฃุนูู ููููู',         body: '<p>ุฃุนูู ููู ูู ุฌุฏูู ุงูุญุณุงุณูุฉ.</p>' },
    discountMin: { title: 'ุงูุญุฏ ุงูุฃุฏูู ููุฎุตู',         body: '<p>ุฎุตู ููุฎูุถ = ุชูููู ุฃุนูู.</p>' },
    discountMax: { title: 'ุงูุญุฏ ุงูุฃุนูู ููุฎุตู',         body: '<p>ุฎุตู ูุฑุชูุน = ุชูููู ุฃูู.</p>' },
    debtRatio:   { title: 'ูุณุจุฉ ุงูุฏูู',                body: '<p>< 30% ููุฎูุถ | 30-60% ูุนุชุฏู | > 60% ูุฑุชูุน.</p>' },
    liquidityRatio:{ title: 'ูุณุจุฉ ุงูุณูููุฉ',            body: '<p>< 1 ุฎุทุฑ | 1-1.5 ููุจูู | > 1.5 ุฌูุฏ.</p>' },
    earningsQuality:{ title: 'ROE',                    body: '<p>< 10% ุถุนูู | 10-15% ุฌูุฏ | > 15% ููุชุงุฒ.</p>' },
    companyType: { title: 'ููุน ุงูุดุฑูุฉ',                body: '<p><strong>ุดุฑูุฉ ุนุงุฏูุฉ:</strong> DCF + ุฌุฑุงูุงู + P/E + Gordon + ุงููููุฉ ุงูุฏูุชุฑูุฉ.</p><p><strong>ุฑูุช ุนูุงุฑู:</strong> NAV ูููุญุฏุฉ + ูุถุงุนู P/FFO.</p>' },
};

function showHelp(field) {
    const h = helpContent[field];
    if (!h) return;
    document.getElementById('helpContent').innerHTML = `<h3>${h.title}</h3>${h.body}`;
    const m = document.getElementById('helpModal');
    m.style.display = 'flex';
    m.classList.remove('hidden');
}
function closeHelp() {
    const m = document.getElementById('helpModal');
    m.style.display = 'none';
    m.classList.add('hidden');
}
document.addEventListener('click', e => {
    const modal = document.getElementById('helpModal');
    if (e.target === modal) closeHelp();
});

// ===== Legal Modal =====
document.getElementById('legalAccept').addEventListener('change', function() {
    const btn = document.getElementById('enterButton');
    btn.disabled = !this.checked;
    btn.classList.toggle('enabled', this.checked);
});
document.getElementById('enterButton').addEventListener('click', function() {
    if (!this.disabled) document.getElementById('legalModal').classList.add('hidden');
});

// ===== Utilities =====
function formatCurrency(amount) {
    if (!isFinite(amount)) return 'โ';
    return new Intl.NumberFormat('ar-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
}
function formatPercent(v) { return v.toFixed(1) + '%'; }

function validateGrowthPerp() {
    const el = document.getElementById('growthPerp');
    const v  = parseFloat(el.value);
    const w  = document.getElementById('growthPerpWarning');
    if (v > 3) { el.value = 3; w.style.display = 'block'; }
    else        { w.style.display = 'none'; }
}

function toggleCompanyType() {
    const t = document.getElementById('companyType').value;
    document.getElementById('normalCompanyInputs').style.display = t === 'normal' ? '' : 'none';
    document.getElementById('reitInputs').style.display          = t === 'reit'   ? '' : 'none';
}

// ===== ููุงุฐุฌ ุงูุญุณุงุจ =====

// โ ุฅุตูุงุญ: total_debt ุงูุขู ููุซู ุงูุฏูู ุงูุตุงูู ููุณูู (net debt per share)
//    equity_value = enterprise_value - net_debt  (ุฅุฐุง ุณุงูุจ = ููุฏูุฉ ุตุงููุฉุ ุชูุถุงู)
function calculate_dcf(fcf, growth_5yr, growth_perp, discount_rate, net_debt) {
    if (discount_rate <= growth_perp) return null;
    if (fcf <= 0) return null;

    let pv_sum = 0;
    let cf5 = fcf * Math.pow(1 + growth_5yr, 5);

    for (let n = 1; n <= 5; n++) {
        const cf = fcf * Math.pow(1 + growth_5yr, n);
        pv_sum += cf / Math.pow(1 + discount_rate, n);
    }

    let cf_prev = cf5;
    for (let n = 6; n <= 10; n++) {
        cf_prev = cf_prev * (1 + growth_perp);
        pv_sum += cf_prev / Math.pow(1 + discount_rate, n);
    }

    const tv_cf           = cf_prev * (1 + growth_perp);
    const tv              = tv_cf / (discount_rate - growth_perp);
    const pv_tv           = tv / Math.pow(1 + discount_rate, 10);
    const enterprise_value = pv_sum + pv_tv;

    // โ equity = EV โ net_debt
    //    net_debt > 0 โ ูุฏูููุฉ โ ุชูุฎูุถ ุงููููุฉ
    //    net_debt < 0 โ ููุฏูุฉ ุตุงููุฉ โ ุชูุฑูุน ุงููููุฉ
    const equity_value = enterprise_value - (net_debt || 0);
    return { enterpriseValue: enterprise_value, equityValue: equity_value };
}

function calculateGraham(eps, growth_rate, bond_yield) {
    if (eps <= 0 || bond_yield <= 0) return null;
    const multiplier = Math.min(8.5 + (2 * growth_rate), 25);
    return (eps * multiplier * 4.4) / bond_yield;
}

function calculate_pe(eps, sector_pe) {
    if (eps <= 0) return null;
    return eps * Math.min(sector_pe, 40);
}

function calculate_gordon(dividends, growth_perp, discount_rate) {
    if (dividends <= 0 || discount_rate <= growth_perp) return null;
    return dividends * (1 + growth_perp) / (discount_rate - growth_perp);
}

function calculate_book_value(book_value, fair_pb) {
    if (book_value <= 0 || fair_pb <= 0) return null;
    return book_value * fair_pb;
}

function calculateWACC(risk_free, beta, market_return, debt_cost, tax_rate, debt_equity) {
    const re = risk_free + beta * (market_return - risk_free);
    const d  = debt_equity;
    const e  = 1;
    const v  = d + e;
    return (e / v * re) + (d / v * debt_cost * (1 - tax_rate));
}

// ===== ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ =====
function calculateFairValue() {
    try {
        document.getElementById('loadingOverlay').classList.remove('hidden');

        const companyType = document.getElementById('companyType').value;
        let growth_perp   = (parseFloat(document.getElementById('growthPerp').value)    || 0) / 100;
        let discount_rate = (parseFloat(document.getElementById('discountRate').value)   || 0) / 100;

        // WACC ุชููุงุฆู
        if (document.getElementById('useWacc').checked) {
            const rf = (parseFloat(document.getElementById('riskFree').value)     || 0) / 100;
            const b  =  parseFloat(document.getElementById('beta').value)          || 1;
            const rm = (parseFloat(document.getElementById('marketReturn').value)  || 0) / 100;
            const rd = (parseFloat(document.getElementById('debtCost').value)      || 0) / 100;
            const tx = (parseFloat(document.getElementById('taxRate').value)       || 0) / 100;
            const de =  parseFloat(document.getElementById('debtEquity').value)    || 0;
            discount_rate = calculateWACC(rf, b, rm, rd, tx, de);
            document.getElementById('discountRate').value = (discount_rate * 100).toFixed(2);
        }

        const scenario    = document.getElementById('scenario').value;
        const growth_adj  = scenario === 'optimistic' ? 0.02 : scenario === 'conservative' ? -0.02 : 0;
        const growth_perp_final = growth_perp + growth_adj;

        if (growth_perp_final >= discount_rate) {
            document.getElementById('loadingOverlay').classList.add('hidden');
            alert(`โ ุฎุทุฃ: ุงูููู ุงูุฏุงุฆู (${(growth_perp_final * 100).toFixed(1)}%) ูุฌุจ ุฃู ูููู ุฃูู ูู ูุนุฏู ุงูุฎุตู (${(discount_rate * 100).toFixed(1)}%).`);
            return;
        }

        let values = {};
        let enterprise_value = 0;
        let fair_value_range = '';
        let fair_value_detail = '';

        if (companyType === 'reit') {
            // ===== ุชูููู ุงูุฑูุช =====
            const nav_total   =  parseFloat(document.getElementById('nav').value)          || 0;
            const totalUnits  = Math.max(parseFloat(document.getElementById('totalUnits').value) || 1, 1);
            const ffo         =  parseFloat(document.getElementById('ffo').value)          || 0;
            const totalDebtR  =  parseFloat(document.getElementById('totalDebt').value)    || 0;
            const capRate     = (parseFloat(document.getElementById('capRate').value)       || 8) / 100;
            // โ ุญูู ุฌุฏูุฏ: ูุถุงุนู P/FFO
            const pffo        =  parseFloat(document.getElementById('pffoMultiple').value) || 12;
            const currentPrice=  parseFloat(document.getElementById('currentPrice').value) || 0;

            if (nav_total <= 0 && ffo <= 0) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert('โ ูุฌุจ ุฅุฏุฎุงู NAV ุฃู FFO ููุฌุจ ููุฑูุช.');
                return;
            }

            const nav_per_unit = (nav_total - totalDebtR) / totalUnits;

            // โ ุฅุตูุงุญ: P/FFO ุงููููุฌ ุงูุตุญูุญ ููุฑูุชุงุช
            const pffo_value  = ffo > 0 ? ffo * pffo : null;

            // ูููุงุณ Cap Rate ุซุงููู ููุชุญูู (NOI โ FFO ุชูุฑูุจู)
            const caprate_check = (ffo > 0 && capRate > 0) ? ffo / capRate : null;

            const ffo_yield   = currentPrice > 0 ? (ffo / currentPrice * 100) : 0;
            enterprise_value  = nav_total;

            const valid_reit  = [nav_per_unit, pffo_value].filter(v => v !== null && v > 0);
            const avg_fair    = valid_reit.length > 0 ? valid_reit.reduce((a, b) => a + b, 0) / valid_reit.length : 0;

            values = {
                'NAV ูููุญุฏุฉ':  nav_per_unit > 0 ? nav_per_unit : null,
                'ูุถุงุนู P/FFO': pffo_value,
                'Cap Rate (ูุฑุฌุน)': caprate_check,
            };

            fair_value_range  = formatCurrency(avg_fair);
            fair_value_detail = `ูุชูุณุท NAV (${formatCurrency(nav_per_unit)}) ู P/FFO (${formatCurrency(pffo_value)}) | ุนุงุฆุฏ FFO: ${ffo_yield.toFixed(2)}%`;

            if (currentPrice > 0 && avg_fair > 0) {
                const margin = ((avg_fair - currentPrice) / avg_fair * 100);
                document.getElementById('dashboardMargin').textContent = `${margin > 0 ? 'โ' : 'โ๏ธ'} ${Math.abs(margin).toFixed(1)}% ${margin > 0 ? 'ูุงูุด ุฃูุงู' : 'ูุจุงูุบ ููู'}`;
            } else {
                document.getElementById('dashboardMargin').textContent = 'โ';
            }

        } else {
            // ===== ุชูููู ุงูุดุฑูุฉ ุงูุนุงุฏูุฉ =====
            const eps          =  parseFloat(document.getElementById('eps').value)          || 0;
            const fcf          =  parseFloat(document.getElementById('fcf').value)          || 0;
            // โ ุฅุตูุงุญ: ูุฑุงุกุฉ ุงูุฏูู ุงูุตุงูู ููุณูู
            const net_debt     =  parseFloat(document.getElementById('netDebt').value)      || 0;
            const growth_5yr   = (parseFloat(document.getElementById('growth5yr').value)    || 0) / 100;
            const sector_pe    =  parseFloat(document.getElementById('sectorPe').value)     || 0;
            const dividends    =  parseFloat(document.getElementById('dividends').value)    || 0;
            const book_value   =  parseFloat(document.getElementById('bookValue').value)    || 0;
            const bond_yield   =  parseFloat(document.getElementById('bondYield').value)    || 6.5;
            const fair_pb      =  parseFloat(document.getElementById('fairPb').value)       || 1.5;
            const currentPrice =  parseFloat(document.getElementById('currentPrice').value) || 0;

            if (eps <= 0 && fcf <= 0) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert('โ ูุฌุจ ุฅุฏุฎุงู EPS ุฃู FCF ููุฌุจ ููุดุฑูุฉ ุงูุนุงุฏูุฉ.');
                return;
            }
            if (bond_yield <= 0) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert('โ ุนุงุฆุฏ ุงูุณูุฏุงุช ูุฌุจ ุฃู ูููู ููุฌุจุงู.');
                return;
            }

            const growth_5yr_adj = growth_5yr + growth_adj;

            // โ ุฅุตูุงุญ: ุชูุฑูุฑ net_debt ุจุฏูุงู ูู 0
            const dcf_result  = calculate_dcf(fcf, growth_5yr_adj, growth_perp_final, discount_rate, net_debt);
            const dcf_value   = dcf_result ? dcf_result.equityValue : null;
            enterprise_value  = dcf_result ? dcf_result.enterpriseValue : 0;

            const graham_value = calculateGraham(eps, growth_5yr_adj * 100, bond_yield);
            const pe_value     = calculate_pe(eps, sector_pe);
            const gordon_value = calculate_gordon(dividends, growth_perp_final, discount_rate);
            const bv_value     = calculate_book_value(book_value, fair_pb);

            values = {
                'DCF':              dcf_value,
                'ุฌุฑุงูุงู':           graham_value,
                'ููุฑุฑ ุงูุฑุจุญูุฉ P/E': pe_value,
                'ุฌูุฑุฏูู':           gordon_value,
                'ุงููููุฉ ุงูุฏูุชุฑูุฉ':  bv_value,
            };

            const valid_values = Object.values(values).filter(v => v !== null && v > 0 && isFinite(v));
            if (valid_values.length === 0) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert('โ ูู ููุชุฌ ุฃู ูููุฐุฌ ูููุฉ ุตุงูุญุฉ. ุชุญูู ูู ุงููุฏุฎูุงุช.');
                return;
            }

            const avg  = valid_values.reduce((a, b) => a + b, 0) / valid_values.length;
            const minV = Math.min(...valid_values);
            const maxV = Math.max(...valid_values);

            fair_value_range  = `${formatCurrency(minV)} โ ${formatCurrency(maxV)}`;
            fair_value_detail = `ุงููุชูุณุท: ${formatCurrency(avg)} | ุงูุณููุงุฑูู: ${scenario === 'realistic' ? 'ูุงูุนู' : scenario === 'optimistic' ? 'ูุชูุงุฆู' : 'ูุญุชุงุท'}`;

            if (currentPrice > 0 && avg > 0) {
                const margin = ((avg - currentPrice) / avg * 100);
                document.getElementById('dashboardMargin').textContent = `${margin > 0 ? 'โ' : 'โ๏ธ'} ${Math.abs(margin).toFixed(1)}% ${margin > 0 ? 'ูุงูุด ุฃูุงู' : 'ูุจุงูุบ ููู'}`;
            } else {
                document.getElementById('dashboardMargin').textContent = 'โ';
            }

            // โ ุฅุตูุงุญ: ุชูุฑูุฑ net_debt ูุฌุฏูู ุงูุญุณุงุณูุฉ
            createSensitivityTable(fcf, growth_5yr_adj, growth_perp_final, discount_rate, net_debt);
            detectAndShowOutliers(Object.fromEntries(Object.entries(values).filter(([, v]) => v !== null && v > 0)));
        }

        // โ ุฅุตูุงุญ: ุนุฑุถ EV ุจุดูู ูุงุถุญ ุญุชู ุนูุฏ DCF=null
        document.getElementById('enterpriseValueRange').textContent =
            enterprise_value > 0 ? formatCurrency(enterprise_value) : 'ุบูุฑ ูุชุงุญ (FCF โค 0 ุฃู ูุง ููุณุชุฎุฏู ููุง)';
        document.getElementById('enterpriseValueDetails').textContent =
            enterprise_value > 0 ? 'ูููุฉ ุงูุดุฑูุฉ ุงูุฅุฌูุงููุฉ ูุจู ุฎุตู ุงูุฏูู ุงูุตุงูู' : 'โ';

        document.getElementById('fairValueRange').textContent  = fair_value_range;
        document.getElementById('fairValueDetails').textContent = fair_value_detail;

        buildModelsTable(values);
        const chart_values = Object.fromEntries(Object.entries(values).filter(([, v]) => v !== null && v > 0 && isFinite(v)));
        createModelsChart(chart_values);

        document.getElementById('dashboardDebt').textContent      = `${document.getElementById('debtRatio').value}%`;
        document.getElementById('dashboardLiquidity').textContent  = parseFloat(document.getElementById('liquidityRatio').value).toFixed(1);
        document.getElementById('dashboardEarnings').textContent   = `${document.getElementById('earningsQuality').value}%`;

        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });

    } catch (err) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        console.error(err);
        alert('ุฎุทุฃ ุฃุซูุงุก ุงูุญุณุงุจ: ' + err.message);
    }
}

// ===== ุฌุฏูู ุงูููุงุฐุฌ =====
function buildModelsTable(values) {
    const currentPrice = parseFloat(document.getElementById('currentPrice').value) || 0;
    const tbody = document.getElementById('modelsTable');
    tbody.innerHTML = '';
    Object.entries(values).forEach(([name, val]) => {
        const tr = document.createElement('tr');
        let status = 'โ';
        if (val !== null && val > 0 && currentPrice > 0) {
            const diff = ((val - currentPrice) / val * 100);
            status = diff > 15
                ? `<span style="color:#27ae60;font-weight:bold">โ ูููููุฉ ุจุฃูู ูู ูููุชูุง (${diff.toFixed(1)}%)</span>`
                : diff < -15
                    ? `<span style="color:#e74c3c;font-weight:bold">๐ด ูุจุงูุบ ูู ุชูููููุง (${Math.abs(diff).toFixed(1)}%)</span>`
                    : `<span style="color:#f39c12;font-weight:bold">๐ก ูุฑุจ ุงููููุฉ ุงูุนุงุฏูุฉ</span>`;
        }
        tr.innerHTML = `
            <td><strong>${name}</strong></td>
            <td>${val !== null && val > 0 ? formatCurrency(val) : '<span style="color:#aaa">ูุง ููุทุจู</span>'}</td>
            <td>${status}</td>`;
        tbody.appendChild(tr);
    });
}

// ===== ุฑุณู ุจูุงูู ููููุงุฐุฌ =====
function createModelsChart(values) {
    const ctx    = document.getElementById('modelsChart').getContext('2d');
    const labels = Object.keys(values);
    const data   = Object.values(values);
    const currentPrice = parseFloat(document.getElementById('currentPrice').value) || 0;
    const colors = data.map(v => v >= currentPrice * 0.85 ? 'rgba(90,157,122,0.7)' : 'rgba(231,76,60,0.7)');
    if (modelsChart) modelsChart.destroy();
    modelsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'ุงููููุฉ ุงูุนุงุฏูุฉ',
                    data,
                    backgroundColor: colors,
                    borderRadius: 8,
                },
                ...(currentPrice > 0 ? [{
                    label: 'ุงูุณุนุฑ ุงูุญุงูู',
                    data: new Array(labels.length).fill(currentPrice),
                    type: 'line',
                    borderColor: '#e74c3c',
                    borderDash: [6, 3],
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                }] : [])
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + formatCurrency(ctx.parsed.y) } }
            },
            scales: { y: { beginAtZero: false, ticks: { callback: v => formatCurrency(v) } } }
        }
    });
}

// ===== ุฌุฏูู ุงูุญุณุงุณูุฉ =====
// โ ุฅุตูุงุญ: ุฅุถุงูุฉ ูุนุงูู net_debt ูุนุฏู ุฅุณูุงุท ูููุชู ูู ูู ุฎููุฉ
function createSensitivityTable(fcf, base_growth, growth_perp, base_discount, net_debt) {
    const growthMin   = (parseFloat(document.getElementById('growthMin').value)   || 5)  / 100;
    const growthMax   = (parseFloat(document.getElementById('growthMax').value)   || 15) / 100;
    const discountMin = (parseFloat(document.getElementById('discountMin').value) || 6)  / 100;
    const discountMax = (parseFloat(document.getElementById('discountMax').value) || 12) / 100;

    const g_steps = [growthMin, (growthMin + growthMax) / 2, growthMax];
    const d_steps = [discountMin, (discountMin + discountMax) / 2, discountMax];

    const table = document.getElementById('sensitivityTable');
    const currentPrice = parseFloat(document.getElementById('currentPrice').value) || 0;

    let html = '<thead><tr><th>ุงูููู \\ ุงูุฎุตู</th>';
    d_steps.forEach(d => { html += `<th>${(d * 100).toFixed(1)}%</th>`; });
    html += '</tr></thead><tbody>';

    g_steps.forEach(g => {
        html += `<tr><td>${(g * 100).toFixed(1)}%</td>`;
        d_steps.forEach(d => {
            // โ ุฅุตูุงุญ: ุชูุฑูุฑ net_debt ุจุฏูุงู ูู 0
            const res = calculate_dcf(fcf, g, growth_perp, d, net_debt || 0);
            const v   = res ? res.equityValue : null;
            let color = '#f8f9fa';
            if (v && currentPrice > 0) {
                color = v > currentPrice * 1.15 ? 'rgba(39,174,96,0.15)'
                      : v < currentPrice * 0.85 ? 'rgba(231,76,60,0.15)'
                      : 'rgba(243,156,18,0.15)';
            }
            html += `<td style="background:${color}">${v ? formatCurrency(v) : 'โ'}</td>`;
        });
        html += '</tr>';
    });

    html += '</tbody>';
    table.innerHTML = html;
}

// ===== ูุดู ุงูุดูุงุฐ =====
function detectAndShowOutliers(values) {
    const el   = document.getElementById('outlierWarning');
    const arr  = Object.entries(values);
    const vals = arr.map(([, v]) => v);
    if (vals.length < 3) { el.style.display = 'none'; return; }

    const mean   = vals.reduce((a, b) => a + b, 0) / vals.length;
    const stdDev = Math.sqrt(vals.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / vals.length);
    const out    = arr.filter(([, v]) => Math.abs(v - mean) > 2 * stdDev);

    if (out.length > 0) {
        el.style.display = 'block';
        el.innerHTML = `โ๏ธ <strong>ุชูุจูู โ ููู ุดุงุฐุฉ:</strong> ูููุฐุฌ ${out.map(([n]) => n).join(' ู')} ูุฎุชูู ุจุฃูุซุฑ ูู ุงูุญุฑุงููู ูุนูุงุฑููู ุนู ุงููุชูุณุท. ุชุญูู ูู ูุฏุฎูุงุชู.`;
    } else {
        el.style.display = 'none';
    }
}

// ===== Toggle WACC Inputs =====
document.getElementById('useWacc').addEventListener('change', function() {
    document.getElementById('waccInputs').style.display = this.checked ? '' : 'none';
});
</script>
<script data-goatcounter="https://investornote.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
